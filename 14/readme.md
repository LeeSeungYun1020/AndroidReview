# Android 14 변경 사항

## 개요

- Android 14의 변경 사항에 대해서 살펴보는 문서입니다.
- Developer Preview 2를 기준으로 작성되었습니다.

## 요약

- 다양한 기기와 폼 팩터에서 작동
    - 태블릿과 폴더블 폼 팩터에 대한 지원 강화
- 백그라운드 작업 간소화
    - JobScheduler와 포그라운드 서비스 업데이트 및 기능 추가
        - 우선순위가 가장 높은 사용자 대상 작업에만 포그라운드 서비스 사용
        - 사용자가 시작한 데이터 전송을 위한 새로운 기능 추가(기존 API 변경)
        - 포그라운드 서비스 유형 선언이 요구되어 포그라운드 서비스에 맞는 사용 사레를 명확히 정의 -> Google Play가 API의 적절한 사용을 보장하는 새로운 정책
          발표 예정
    - 브로드캐스트 최적화
        - 앱이 캐시된 상태에서는 컨텍스트 등록 브로드캐스트가 큐에 저장되며 전달되기 전에 하나로 병합(BATTERY_CHANGED 같은 반복 브로드캐스트)될 수 있음
    - 정확한 알람
        - Android 13이상을 대상으로 새로 설치된 앱은 SCHEDULE_EXACT_ALARM을 사용자에게 허가받아야 함
        - 시계 및 캘린더 앱은 설치시 권한이 부여되는 USE_EXACT_ALARM 권한을 선언할 수 있지만 핵심 앱 기능이 아닌 경우 Google Play에 게시할 수
          없음
- 맞춤 설정
    - 비선형 크기 조정으로 200%까지 확대
        - 텍스트가 너무 커지는 문제를 완화하기 위해 이미 충분히 큰 텍스트는 적은 비율로 확대
    - 앱별 언어 설정
        - localConfig를 동적으로 업데이트하여 Android 설정의 앱별 언어 목록에 표시될 언어 집합을 맞춤 설정 가능
        - IME는 현재 앱의 UI 언어를 파악하여 표시될 키보드 언어를 업데이트 가능
    - 성별이 있는 언어 지원
        - 문자열 기준으로 적용되는 ICU의 SelectFormat 보다 쉽게 성별이 있는 언어를 지원
- 개인정보 보호 및 보안
    - 런타임 브로드캐스트 리시버
        - 동적으로 등록되는 브로드캐시트 리시버는 exported 또는 unexported로 지정해야 함
    - 더 안전한 암시적 인텐트
        - 패키지가 지정되지 않은 인텐트를 내부적으로 전송할 수 없음(내보내지 않은 활동을 시작하려면 명식적 인텐트를 사용해야 함)
    - 더 안전한 동적 코드 로딩
        - 동적으로 로드된 파일은 읽기 전용으로 설정해야 함
    - 앱 설치 차단
        - targetSdkVersion 23 미만 설치 불가
    - Credential Manager와 패스 키 지원
        - 사용자 인증 과정을 단순화하고 패스키 지원으로 보안 강화할 수 있는 Credential Manager API(생체 인증으로 안전한 로그인)
- 앱 호환성
    - OpenJDK 17 지원
        - Java 17 언어 기능 제공
    - 쉬워진 변경 사항 테스트와 디버깅
        - adb 또는 개발자 옵션에서 변경 사항을 강제 적용 및 해제 가능(앱의 targetSdkVersion을 변경하지 않고 특정 변경사항만 적용해 볼 수 있음)

## 동작 변경 사항

### 모든 앱에 적용되는 사항

#### 핵심 기능

##### schedule exact alarm이 기본적으로 거부됩니다.

- exact alarm은 사용자가 지정한 알림이거나 정확한 시간에 발생할 필요가 있는 동작을 의미합니다.
- SCHEDULE_EXACT_ALARM 권한은 Android 13 이상을 타겟팅하는 새로 설치된 앱에서 더이상 미리 허가되지 않으며 기본적으로 거부됩니다.

##### context에 등록된 브로드캐스트는 앱이 캐시된 상태에서 대기합니다.

- 매니페스트에 선언된 브로드캐스트는 대기열(큐)에 추가되지 않으며 브로드캐스트 전달을 위해 앱이 캐시된 상태에서 제거됩니다.
- 앱이 캐시된 상태에서 벗어나 포그라운드로 돌아오면, 시스템은 대기열(큐)의 모든 브로드캐스트를 가져오고 특정 브로드캐스트의 여러 인스턴스는 하나의 브로드캐스트로 합쳐질 수
  있습니다.

##### 앱은 자신의 백그라운드 프로세스만 종료할 수 있습니다.

- killBackgroundProcesses()를 호출하여도 자신의 앱의 백그라운드 프로세스만 종료됩니다.
- 다른 앱의 패키지 이름을 통해 종료를 시도하여도 해당 앱의 백그라운드 프로세스에는 어떠한 영향도 없으며 Logcat에 Invalid packageName:
  com.example.anotherapp 메시지가 표시됩니다.
- 이전 버전의 OS에서도 killBackgroundProcesses() API를 사용해서는 안되며(shouldn't) 다른 앱의 생명주기에 영향을 끼치려고 해서는 안 됩니다.
- 안드로이드는 백그라운드에 캐시된 앱을 유지하며 시스템이 메모리가 필요한 경우에 자동으로 종료되도록 설계되었습니다.
- 내 앱이 다른 앱을 불필요하게 종료한다면, 나중에 다른 앱을 완전히 다시 시작해야하므로 캐시된 앱을 재시작하는 것보다 훨씬 더 많은 리소스가 필요합니다. 이는 시스템 성능을
  저하시키고 배터리 소모를 증가시킬 수 있습니다.

#### 보안

##### 설치 가능한 최소 타겟 API 레벨

- targetSdkVersion이 23 미만인 앱은 설치할 수 없습니다.
- 맬웨어는 오래된 API 레벨을 타겟하여 새로운 안드로이드 버젼에서 적용된 보안과 개인 정보 보호를 우회합니다.
- 대표적으로 Android 6.0(API level 23)에서 도입된 런타임 퍼미션 모델을 회피하기 위해 targetSdkVersion을 22로 하는 멜웨어 앱이 있습니다.
- 낮은 API 레벨을 타겟팅하는 앱을 설치하려고 시도하면 설치가 실패하며 Logcat에 INSTALL_FAILED_DEPRECATED_SDK_VERSION: App package
  must target at least SDK version 23, but found 7가 표시됩니다.
- Android 14로 업그레이드하는 장치에 기존에 설치된 앱은 그대로 유지되며, ADB 명령어 adb install --bypass-low-target-sdk-block
  FILENAME.apk를 통해 이전 API 레벨의 앱을 설치하여 테스트할 수 있습니다.

##### 미디어 owner package name이 수정될 수 있습니다.

- 미디어 저장소는 특정 미디어 파일을 저장한 앱을 나타내는 OWNER_PACKAGE_NAME 칼럼에 대한 쿼리를 지원합니다.
- Android 14 부터는 다음 조건 중 하나 이상이 참인 경우 이 값이 수정됩니다.
    - 항상 다른 앱이 볼 수 있는 패키지 이름으로 된 미디어 파일을 저장한 앱
    - QUERY_ALL_PACKAGES 권한을 요청하며 미디어 저장소를 쿼리하는 앱
        - Google Play는 위험하거나 민감한 권한을 사용하는 것을 제한하고 있습니다. 따라서 QUERY_ALL_PACKAGES 권한이 앱의 주요 목적에 사용되는
          경우에만 사용가능하며 Play의 정책 요구사항을 만족하는 경우에만 Google Play에 게시될 수 있습니다.

#### 사용자 경험

##### 고정(제거할 수 없는) 알림에 대한 사용자 경험 변경

- Notification.FLAG_ONGOING_EVENT를 Notification.Builder.setOngoing(true)로 지정한 경우 사용자는 해당 알림을 제거할 수
  있습니다.
- 아래 사항에서는 여전히 알림을 제거할 수 없습니다.
    - 휴대전화가 잠금 상태인 경우
    - Clear all 버튼으로 알림을 제거하는 경우
    - MediaStyle을 사용하여 만들어진 미디어 재생 알림
    - 보안과 개인 정보와 연관되어 정책을 제한하는 경우
    - DPC(Device Policy Controller)와 기업용 지원 패키지

##### 사진과 영상에 대한 부분적인 액세스 권한 부여

- Android 13에서 도입된 READ_MEDIA_IMAGES, READ_MEDIA_VIDEO 권한을 요청할 경우 사용자는 부분적인 액세스 권한을 허가할 수 있습니다.
- 새로운 권한 선택 다이얼로그에서는 사진과 영상 선택, 항상 모두 허용, 거부 옵션이 표시됩니다.
- 앱에서 photo picker를 사용하는 경우에는 변경사항에 대응할 필요가 없습니다.
- 더 세밀하게 권한을 다루고 싶다면 READ_MEDIA_VISUAL_USER_SELECTED 권한을 사용하는 것을 고려하십시오.

#### 접근성

##### 비선형 폰트 200% 스케일링

- 최대 200% 스케일링과 저시력 사용자를 위해 WCAG(Web Content Accessibility Guidelines)에 맞게 정렬하는 추가적인 접근성 옵션을 지원합니다.
- 텍스트에 sp 단위를 사용하고 있다면 앱에 큰 영향은 없을 것으로 예상됩니다. 그러나 앱이 사용성에 영향을 주지 않는지 200% 스케일링을 적용한 상태에서 UI 테스트가
  필요합니다.

### Android 14를 타겟팅하는 앱에 적용되는 사항

#### 핵심 기능

##### 포그라운드 서비스의 타입이 요구됨

- 앱의 각 포그라운드 서비스에는 하나 이상의 포그라운드 서비스 타입이 명시되어야 합니다.
- 시스템은 특정 유즈케이스를 충족하기 위해 특정 포그라운드 서비스 타입을 기대합니다.
    - Android 14에서는 health, remote messaging, short services, special use cases, system exemptions
      같은 포그라운드 서비스 타입을 도입하였습니다.
- 앱의 유즈 케이스가 이러한 타입과 연관되지 않은 경우 로직을 WorkManager 또는 user-initiated data transfer jobs로 이관하는 것을 강력히
  추천합니다.

#### 보안

##### 암시적 인텐트와 펜딩 인텐트의 제한 사항

- 암시적 인텐트는 exported 컴포넌트에만 전달됩니다. exported 되지 않은 컴포넌트에 인텐트를 전달하려면 명시적 인텐트를 사용해야 합니다.
- 변경할 수 있는(MUTABLE) 펜딩 인텐트를 컨포넌트 또는 패키지 명시 없이 생성하면 시스템이 예외를 발생시킵니다.
- 변경 사항으로 악성 앱이 앱의 내부 컴포넌트를 실행할 목적으로 생성한 암시적 인텐트를 가로챌 수 없도록 보호합니다.

```kotlin
val explicitIntent = Intent("com.example.action.APP_ACTION")
explicitIntent.apply {
    package = context.packageName
}
context.startActivity(explicitIntent)
```

##### 런타임에 등록된 브로드캐스트 리시버는 export 동작을 명시해야 합니다.

- 컨텍스트에 등록되는 리시버는 디바이스의 모든 앱에 내보낼지 여부를 플래그로 지정해야 합니다.
- Android 13 에서 추가된 기능(모든 앱이 동적으로 등록된 리시버로 보호되지 않은 리시버를 보낼 수 있는 문제 해결)을 강제하여 보안 취약성으로부터 앱을 보호할 수
  있습니다.

##### 시스템 브로드캐스트만 수신하는 리시버에 예외 발생

- 시스템 브로드캐스트만을 수신하는 리시버를 컨텍스트에 등록할 때, flag를 지정하면 얘외가 발생합니다.

##### 안전한 동적 코드 로딩

- DCL(Dynamic Code Loading)을 사용할 때, 동적으로 로드된 파일은 읽기 전용으로 표시되어야 합니다. 그렇지 않으면 시스템은 예외를 발생시킵니다.
- 코드 삽입, 변조로 인해 앱이 손상될 수 있는 위험이 크게 증가되므로 가능하다면 앱에서 동적으로 코드를 로드하지 않아야 합니다.
- 그럼에도 코드 동적 로드가 필요한 경우, 파일을 열자마자 읽기 전용으로 설정하고 내용을 작성해야 합니다.
- 동적으로 로드된 기존 파일에서 예외가 발생하지 않도록 하려면 파일을 삭제하고 다시 로드하는 것을 권장합니다.

##### 백그라운드에서 액티비티를 시작할 때, 추가 제한 사항 적용

- 펜딩 인텐트를 send 또는 유사 함수로 보낼 때, 펜딩 인텐트를 시작하여 백그라운드에서 액티비티를 시작하는 권한을 허용하려면 ActivityOptions 번들에
  setPendingIntentBackgroundActivityStartMode(MODE_BACKGROUND_ACTIVITY_START_ALLOWED)를 지정해야 합니다.
- 보이는 앱이 백그라운드에 있는 다른 앱의 서비스를 bindService()로 바인드하고 바인드된 서비스에서 백그라운드 활동 시작 권한을 부여하려는 경우,
  bindService()를 호출할 때 BIND_ALLOW_ACTIVITY_STARTS 플래그를 포함해야 합니다.
- 추가 제한 사항 적용으로 악성 앱이 API를 남용하여 파괴적인 액티비티를 백그라운드에서 시작하는 것을 막을 수 있습니다.

#### 비 SDK 제한 사항 업데이트

- Android 14에는 일부 제한된 비 SDK 인터페이스가 변경되었습니다.
- 일부 비 SDK 인터페이스를 사용할 수 있지만 이러한 메소드와 필드를 사용하면 항상 앱이 중단될 위험이 높아지므로 대체할 수 있는 SDK 인터페이스로 마이그레이션해야 합니다.
- 앱의 기능에 비 SDK 인터페이스 사용 외에 다른 방법을 찾을 수 없는 경우 새 공개 API를 요청해야 합니다.

## 새로운 기능

### 기능 및 API 개요

Android 14에서는 개발자를 위한 멋진 새로운 기능과 API를 도입하였습니다.
새롭게 추가, 수정, 삭제된 API는 API 차이 보고서([API difference report](https://developer.android.com/sdk/api_diff/u-dp1/changes))에서 상세
목록 확인이 가능합니다.

### 국제화

#### 앱별 언어 기본 설정

Android 13에서 시작된 앱별 언어 기능이 확장되었습니다.

- 앱의 localConfig를 자동으로 생성합니다.
    - Android Studio Giraffe Canary 7과 AGP 8.1.0-alpha07 이상에서는 앱별 언어 기본 설정을 자동으로 지원하도록 앱을 구성할 수 있습니다.
    - 프로젝트 리소스를 기반으로 Android Gradle 플러그인이 LocalConfig 파일을 생성하고 최종 매니페스트 파일에 해당 파일에 대한 참조를 추가하여 수동으로 파일을 생성하거나 업데이트할 필요가
      없어집니다.
    - AGP는 앱 모듈의 res 폴더에 있는 리소스와 라이브러리 모듈의 디펜던시를 사용하여 LocaleConfig 파일에 포함될 로케일을 결정합니다.
- 앱의 localConfig를 동적으로 변경할 수 있습니다.
    - LocaleManager의 setOverrideLocaleConfig 또는 getOverrideLocaleConfig를 이용하여 기기 시스템 설정에서 표시되는 앱의 지원되는 언어 목록을 동적으로 변경할 수
      있습니다.
    - 지역별로 지원되는 언어 목록을 변경하거나, A/B 테스트 수행, 현지화를 위해 서버 측 푸시를 사용하여 업데이트된 로케일 목록을 제공받는 경우 유용하게 사용할 수 있을 것입니다.

